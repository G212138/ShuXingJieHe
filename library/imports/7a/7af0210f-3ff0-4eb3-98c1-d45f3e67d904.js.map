{"version":3,"sources":["assets\\game\\scripts\\UI\\Layer\\GameLayer.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import { NetWork } from \"../../../../frame/scripts/Http/NetWork\";\nimport { ListenerManager } from \"../../../../frame/scripts/Manager/ListenerManager\";\nimport { SyncDataManager } from \"../../../../frame/scripts/Manager/SyncDataManager\";\nimport { T2M } from \"../../../../frame/scripts/SDK/T2M\";\nimport { EventType } from \"../../Data/EventType\";\nimport Cube from \"../Item/Cube\";\nimport GameUI from \"../Item/GameUI\";\nimport ThreeNode from \"../Item/ThreeDNode\";\n\nconst { ccclass, property } = cc._decorator;\n\n@ccclass\nexport default class GameLayer extends cc.Component {\n    @property(ThreeNode)\n    private threeDNode: ThreeNode = null;\n    @property(GameUI)\n    private gameUI: GameUI = null;\n\n    @property(cc.Node)\n    private threeDCamera: cc.Node = null;\n    @property(cc.Node)\n    private cubeRootNode: cc.Node = null;\n    @property(cc.Node)\n    private addMinus: cc.Node = null;\n    @property(cc.Node)\n    private img_huangbian: cc.Node[] = [];\n\n    private touchEventId: number;\n\n    onLoad() {\n        ListenerManager.on(EventType.ENTER_GAME, this.handleEnterGame, this);\n        ListenerManager.on(EventType.GAME_RECONNECT, this.handleEnterGame, this);\n\n        T2M.addSyncEventListener(EventType.DRAG_END, this.handleDragEnd.bind(this));\n        // this.node.on(cc.Node.EventType.TOUCH_START, this.onTouchStart, this)\n        // this.node.on(cc.Node.EventType.TOUCH_MOVE, this.onTouchMove, this)\n        // this.node.on(cc.Node.EventType.TOUCH_END, this.onTouchEnd, this)\n    }\n    onDestroy() {\n        ListenerManager.off(EventType.ENTER_GAME, this.handleEnterGame, this);\n        ListenerManager.off(EventType.GAME_RECONNECT, this.handleEnterGame, this);\n\n        T2M.removeSyncEventListener(EventType.DRAG_END);\n        // this.node.off(cc.Node.EventType.TOUCH_START, this.onTouchStart, this)\n        // this.node.off(cc.Node.EventType.TOUCH_MOVE, this.onTouchMove, this)\n        // this.node.off(cc.Node.EventType.TOUCH_END, this.onTouchEnd, this)\n    }\n\n    private handleEnterGame() {\n        this.threeDNode.init();\n        this.gameUI.init();\n\n        let eulerX = SyncDataManager.getSyncData().customSyncData.eulerX;\n        let eulerY = SyncDataManager.getSyncData().customSyncData.eulerY;\n        let eulerZ = SyncDataManager.getSyncData().customSyncData.eulerZ;\n        let rotation = cc.quat();\n        cc.Quat.fromEuler(rotation, eulerX, eulerY, eulerZ);\n        this.cubeRootNode.setRotation(rotation);\n    }\n\n    private onDragStart(data) {\n        this.addMinus.active = false;\n        this.img_huangbian[0].active = false;\n        this.img_huangbian[1].active = false;\n        this.img_huangbian[2].active = false;\n    }\n\n    private onDragMove(data) {\n        let pos = data.target.parent.convertToWorldSpaceAR(cc.v2(data.pos.x, data.pos.y));\n        let prevPos = data.target.parent.convertToWorldSpaceAR(cc.v2(data.prevLocation.x, data.prevLocation.y));\n        let prevLocation = cc.v2(prevPos.x, prevPos.y);\n        let curLocation = cc.v2(pos.x, pos.y);\n\n        let vel = curLocation.sub(prevLocation);\n        let disX = vel.x;\n        let disY = vel.y;\n\n        let eulerX = this.cubeRootNode.eulerAngles.x;\n        let eulerY = this.cubeRootNode.eulerAngles.y;\n        let eulerZ = this.cubeRootNode.eulerAngles.z;\n        let quat = new cc.Quat()\n        cc.Quat.fromEuler(quat, eulerX, eulerY, eulerZ)\n        let changed = false;\n        let dot = vel.normalize().dot(cc.Vec2.RIGHT);\n        let rotateByUp = Math.abs(dot) > Math.cos(cc.misc.degreesToRadians(45));\n        if ( rotateByUp) {\n            let angle = (disX / 2436 * 360);\n            // eulerY += angle\n            cc.Quat.rotateAround(quat, quat, cc.Vec3.UP, cc.misc.degreesToRadians(angle))\n            changed = true\n        }\n        if ( !rotateByUp) {\n            let angle = -(disY / 2436 * 720);\n            // eulerX += angle\n            cc.Quat.rotateAround(quat, quat, this.threeDCamera.right, cc.misc.degreesToRadians(angle))\n            changed = true\n        }\n\n        if (changed) {\n            let outEuler = cc.v3()\n            quat.toEuler(outEuler)\n            this.onChangeBigCubeEuler(outEuler.x, outEuler.y, outEuler.z)\n        }\n\n\n\n\n        // let dif = data.target.parent.convertToWorldSpaceAR(cc.v2(data.delta.x, data.delta.y));\n        // let q_tmp = new cc.Quat();\n        // let v_tmp = cc.v3(-dif.y, dif.x, 0);\n        // v_tmp.normalizeSelf();\n        // let eulerX = this.cubeRootNode.eulerAngles.x;\n        // let eulerY = this.cubeRootNode.eulerAngles.y;\n        // let eulerZ = this.cubeRootNode.eulerAngles.z;\n        // let quat = new cc.Quat()\n        // cc.Quat.fromEuler(quat, eulerX, eulerY, eulerZ)\n        // let out_Q = cc.Quat.rotateAround(q_tmp, quat, v_tmp, Math.PI * 0.007);\n        // this.cubeRootNode.setRotation(out_Q.x, out_Q.y, out_Q.z, out_Q.w);\n    }\n\n    private onDragEnd(data) {\n        if (data.isClick) {\n            this.addMinus.active = false;\n            this.img_huangbian[0].active = false;\n            this.img_huangbian[1].active = false;\n            this.img_huangbian[2].active = false;\n        }\n        this.node.position = cc.Vec3.ZERO;\n        if (data.isClick && SyncDataManager.getSyncData().customSyncData.enableClick) {\n            let pos = data.target.parent.convertToWorldSpaceAR(cc.v2(data.pos.x, data.pos.y));\n            let location = cc.v2(pos.x, pos.y);\n            let ray = this.threeDCamera.getComponent(cc.Camera).getRay(location);\n            let results = cc.geomUtils.intersect.raycast(this.cubeRootNode, ray, null, null);\n            for (let i = 0; i < results.length; i++) {\n                if (results[0].node.parent.getComponent(Cube) && results[1]) {\n                    results[0].node.parent.getComponent(Cube).clickCube(results[1].node.name);\n                }\n                return;\n            }\n        }\n\n        if (NetWork.isMaster || !NetWork.isSync) {\n            let data = {\n                eulerX: SyncDataManager.getSyncData().customSyncData.eulerX,\n                eulerY: SyncDataManager.getSyncData().customSyncData.eulerY,\n                eulerZ: SyncDataManager.getSyncData().customSyncData.eulerZ\n            }\n            T2M.dispatch(EventType.DRAG_END, data);\n        }\n    }\n\n    private onChangeBigCubeEuler(eulerX: number, eulerY: number, eulerZ: number) {\n        let rotation = cc.quat();\n        cc.Quat.fromEuler(rotation, eulerX, eulerY, eulerZ);\n        SyncDataManager.getSyncData().customSyncData.eulerX = eulerX;\n        SyncDataManager.getSyncData().customSyncData.eulerY = eulerY;\n        SyncDataManager.getSyncData().customSyncData.eulerZ = eulerZ;\n        this.cubeRootNode.setRotation(rotation);\n    }\n\n    private handleDragEnd(data: any) {\n        let rotation = cc.quat();\n        cc.Quat.fromEuler(rotation, data.eulerX, data.eulerY, data.eulerZ);\n        this.cubeRootNode.setRotation(rotation);\n        //将this.cubeRootNode的轴重置为世界坐标系的轴\n        // let euler = this.cubeRootNode.eulerAngles;\n        // let quat = new cc.Quat()\n        // cc.Quat.fromEuler(quat, euler.x, euler.y, euler.z)\n        // let outEuler = cc.v3()\n        // quat.toEuler(outEuler)\n        // this.onChangeBigCubeEuler(outEuler.x, outEuler.y, outEuler.z)\n    }\n}\n"]}